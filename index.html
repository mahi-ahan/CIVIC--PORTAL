
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Civic Portal 3D + Media</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta/dist/vanta.net.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHmBp995CjoDdpr2JJ4TWXKFwOjNAaqTw&libraries=places" async defer></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Poppins',sans-serif;background:#0d0d0d;color:#fff;min-height:100vh}
#bg{position:fixed;inset:0;z-index:-1}
header{padding:24px;text-align:center;font-family:'Orbitron',sans-serif}
header h1{font-size:26px;background:linear-gradient(90deg,#ff4d4d,#ffcc00,#00e5ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.card{max-width:820px;margin:20px auto;padding:20px;border-radius:16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(8px)}
input,select,textarea,button{width:100%;padding:12px;border-radius:10px;border:none;margin-top:10px;background:rgba(255,255,255,0.06);color:#fff;font-size:15px}
.btn{background:linear-gradient(90deg,#ff4d4d,#00e5ff);cursor:pointer;box-shadow:0 6px 18px rgba(0,229,255,0.08)}
.btn-danger{background:#b71c1c}
.small{font-size:13px;color:#ddd;margin-top:8px}
.hidden{display:none}
.upload-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
.preview{margin-top:8px}
img,video,audio{max-width:100%;border-radius:8px}
.controls{display:flex;gap:10px;margin-top:8px}
.reports-list > .report{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.03)}
.error{color:#ff6b6b;font-size:14px;margin-top:8px}
.success{color:#00e676;font-size:14px;margin-top:8px}
@media(max-width:720px){.card{margin:12px;padding:14px}}
</style>
</head>
<body>
<div id="bg"></div>
<header><h1>ğŸš€ Futuristic Civic Portal</h1></header>

<!-- ROLE SELECTION -->
<div id="page0" class="card">
<h2>ğŸ‘¤ Who are you?</h2>
<p class="small">Choose role to continue</p>
<div style="display:flex;gap:12px;margin-top:16px">
<button class="btn" onclick="goto('userLogin')">I am a User</button>
<button class="btn" onclick="goto('adminLogin')">I am an Admin</button>
</div>
</div>

<!-- USER GOOGLE LOGIN -->
<div id="userLogin" class="card hidden">
<h2>ğŸ”‘ Sign in with Google</h2>
<div id="g_id_onload"
data-client_id="206870259193-04tn3lhqmn4sf61cmp7l0pmgntafclnf.apps.googleusercontent.com"
data-callback="handleCredentialResponse">
</div>
<div class="g_id_signin" data-type="standard"></div>
<p class="small">After signing in you'll be taken to the user portal</p>
<p class="small"><a href="#" style="color:#00e5ff" onclick="goto('page0')">â† Back</a></p>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
<h2>ğŸ” Admin Login</h2>
<input id="adminId" placeholder="Admin ID ">
<input id="adminPass" placeholder="Password " type="password">
<div style="display:flex;gap:10px;margin-top:12px">
<button class="btn" onclick="adminLogin()">Login</button>
<button class="btn" onclick="goto('page0')" style="background:rgba(255,255,255,0.06)">Cancel</button>
</div>
<p id="adminError" class="error hidden">âŒ Incorrect ID or Password</p>
</div>

<!-- USER PORTAL -->
<div id="page3" class="card hidden">
<h2>âš¡ Report an Issue</h2>
<textarea id="issueDesc" placeholder="Describe the issue..." rows="3"></textarea>
<select id="issueCat">
<option value="">Select category</option>
<option>Electricity</option>
<option>Water</option>
<option>Streetlight</option>
<option>Road</option>
<option>Sanitation</option>
</select>

<!-- Location + Map -->
<div style="margin-top:12px">
<label class="small">ğŸ“ Problem location (drag marker or click map)</label>
<input id="locationTxt" placeholder="Search or pick location on map">
<div id="map" style="height:220px;margin-top:8px;border-radius:8px;overflow:hidden"></div>
</div>

<!-- IMAGE CAPTURE -->
<div style="margin-top:12px">
<label class="small">ğŸ“· Image (upload or capture)</label>
<div class="upload-row">
<input id="imgUpload" type="file" accept="image/*" capture="environment">
<button class="btn" id="startCamBtn" type="button">Start Camera</button>
<button class="btn btn-danger hidden" id="removeImgBtn" type="button">Remove Image</button>
</div>
<video id="imgVideo" class="hidden preview" autoplay playsinline style="max-height:300px"></video>
<div class="controls hidden" id="imgCamControls">
<button class="btn" id="takePhotoBtn" type="button">Take Photo</button>
<button class="btn" id="stopCamBtn" type="button">Stop Camera</button>
</div>
<canvas id="imgCanvas" class="hidden"></canvas>
<img id="imgPreview" class="hidden preview" alt="image preview">
</div>

<!-- VIDEO CAPTURE -->
<div style="margin-top:14px">
<label class="small">ğŸ¥ Video (upload or record)</label>
<div class="upload-row">
<input id="vidUpload" type="file" accept="video/*" capture="camcorder">
<button class="btn" id="startVidRec" type="button">Start Recording</button>
<button class="btn hidden" id="stopVidRec" type="button">Stop Recording</button>
<button class="btn btn-danger hidden" id="removeVidBtn" type="button">Remove Video</button>
</div>
<video id="vidPreview" class="hidden preview" controls style="max-height:300px"></video>
</div>

<!-- AUDIO CAPTURE -->
<div style="margin-top:14px">
<label class="small">ğŸ™ Audio (upload or record)</label>
<div class="upload-row">
<input id="audUpload" type="file" accept="audio/*" capture="microphone">
<button class="btn" id="startAudRec" type="button">Start Recording</button>
<button class="btn hidden" id="stopAudRec" type="button">Stop Recording</button>
<button class="btn btn-danger hidden" id="removeAudBtn" type="button">Remove Audio</button>
</div>
<audio id="audPreview" class="hidden preview" controls></audio>
</div>

<div style="display:flex;gap:12px;margin-top:16px">
<button class="btn" onclick="submitReport()">Submit Report</button>
<button class="btn" onclick="logoutUser()" style="background:rgba(255,255,255,0.06)">Logout</button>
</div>
<div id="submitMsg" class="success hidden">âœ… Report submitted successfully!</div>
<h3 style="margin-top:18px">ğŸ“‹ My Reports</h3>
<div id="userReports" class="reports-list"></div>
</div>

<!-- ADMIN PORTAL -->
<div id="page4" class="card hidden">
<h2>ğŸ›  Admin Dashboard</h2>
<div id="allReports" class="reports-list"></div>
<h3 style="margin-top:18px">ğŸ“Š Analytics</h3>
<canvas id="statusChart" style="margin-top:8px"></canvas>
<div style="margin-top:12px">
<button class="btn" onclick="goto('page0')" style="background:rgba(255,255,255,0.06)">Back to Role Select</button>
</div>
</div>

<script>
// --------------------- VANTA background ---------------------
VANTA.NET({ el:"#bg", mouseControls:true, touchControls:true, minHeight:200, minWidth:200, scale:1.0, scaleMobile:1.0, color:0xff4d4d, backgroundColor:0x0d0d0d, points:12, maxDistance:22, spacing:18 });

// --------------------- Navigation ---------------------
function goto(id){
const pages=['page0','userLogin','adminLogin','page3','page4'];
pages.forEach(p=>{document.getElementById(p).classList.add('hidden');});
document.getElementById(id).classList.remove('hidden');
if(id==='page3'){ renderUserReports(); setTimeout(()=>{ if(typeof initMap==='function') initMap(); },300);}
if(id==='page4'){ renderAllReports(); updateCharts();}
}

// --------------------- Google Sign-in ---------------------
let currentUserEmail=null;
function decodeJwt(token){try{const base64Url=token.split('.')[1];const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');const jsonPayload=decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));return JSON.parse(jsonPayload);}catch(e){return null;}}
function handleCredentialResponse(response){const data=decodeJwt(response.credential);if(data&&data.email){currentUserEmail=data.email;localStorage.setItem('civic_current_user',currentUserEmail);goto('page3');}else{alert('Google sign-in failed.');}}

// --------------------- Admin Login ---------------------
function adminLogin(){const id=document.getElementById('adminId').value.trim();const pass=document.getElementById('adminPass').value.trim();const err=document.getElementById('adminError');if(id==='civic01'&&pass==='admin45'){err.classList.add('hidden');document.getElementById('adminId').value='';document.getElementById('adminPass').value='';goto('page4');}else{err.classList.remove('hidden');}}

// --------------------- Data store ---------------------
let reports=JSON.parse(localStorage.getItem('civic_reports')||'[]');

// --------------------- Maps ---------------------
let map, marker, geocoder;
function initMap(){
const el=document.getElementById('map'); if(!el) return;
if(map) return;
geocoder=new google.maps.Geocoder();
const defaultPos={lat:28.6139,lng:77.2090};
map=new google.maps.Map(el,{center:defaultPos,zoom:12});
marker=new google.maps.Marker({map,position:defaultPos,draggable:true});
const input=document.getElementById('locationTxt');
const autocomplete=new google.maps.places.Autocomplete(input);
autocomplete.bindTo('bounds',map);
autocomplete.addListener('place_changed',()=>{
const place=autocomplete.getPlace();if(!place.geometry) return;
map.setCenter(place.geometry.location);map.setZoom(15);
marker.setPosition(place.geometry.location);
input.dataset.lat=place.geometry.location.lat();
input.dataset.lng=place.geometry.location.lng();
});
marker.addListener('dragend',()=>{
const pos=marker.getPosition();
geocoder.geocode({location:pos},(results,status)=>{if(status==='OK'&&results[0]){input.value=results[0].formatted_address;input.dataset.lat=pos.lat();input.dataset.lng=pos.lng();}});
});
map.addListener('click',(e)=>{
marker.setPosition(e.latLng);
geocoder.geocode({location:e.latLng},(results,status)=>{if(status==='OK'&&results[0]){input.value=results[0].formatted_address;input.dataset.lat=e.latLng.lat();input.dataset.lng=e.latLng.lng();}});
});
}

// --------------------- Media Capture ---------------------
let camStream=null, vidRecorder=null, vidChunks=[], audRecorder=null, audChunks=[];

const imgVideo=document.getElementById('imgVideo');
const imgCanvas=document.getElementById('imgCanvas');
const imgPreview=document.getElementById('imgPreview');
const removeImgBtn=document.getElementById('removeImgBtn');

document.getElementById('startCamBtn').onclick=async()=>{
try {
camStream=await navigator.mediaDevices.getUserMedia({video:true});
imgVideo.srcObject=camStream;
imgVideo.classList.remove('hidden');
document.getElementById('imgCamControls').classList.remove('hidden');
} catch (error) {
console.error("Error accessing camera:", error);
alert("Could not access camera. Please check permissions.");
}
};
document.getElementById('takePhotoBtn').onclick=()=>{
imgCanvas.width=imgVideo.videoWidth; imgCanvas.height=imgVideo.videoHeight;
imgCanvas.getContext('2d').drawImage(imgVideo,0,0);
imgPreview.src=imgCanvas.toDataURL('image/png'); imgPreview.classList.remove('hidden');
removeImgBtn.classList.remove('hidden');
};
document.getElementById('stopCamBtn').onclick=()=>{
if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
imgVideo.classList.add('hidden'); document.getElementById('imgCamControls').classList.add('hidden');
};

removeImgBtn.onclick=()=>{imgPreview.classList.add('hidden'); removeImgBtn.classList.add('hidden');};

// --------------------- Video ---------------------
const vidPreview=document.getElementById('vidPreview');
const removeVidBtn=document.getElementById('removeVidBtn');

document.getElementById('startVidRec').onclick=async()=>{
try {
const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
vidRecorder=new MediaRecorder(stream); vidChunks=[];
vidRecorder.ondataavailable=e=>vidChunks.push(e.data);
vidRecorder.onstop=()=>{vidPreview.src=URL.createObjectURL(new Blob(vidChunks,{type:'video/webm'})); vidPreview.classList.remove('hidden'); removeVidBtn.classList.remove('hidden');};
vidRecorder.start();
document.getElementById('stopVidRec').classList.remove('hidden'); document.getElementById('startVidRec').classList.add('hidden');
} catch (error) {
console.error("Error accessing video recorder:", error);
alert("Could not access camera/microphone. Please check permissions.");
}
};

document.getElementById('stopVidRec').onclick=()=>{
if(vidRecorder){vidRecorder.stop(); vidRecorder=null;}
document.getElementById('stopVidRec').classList.add('hidden'); document.getElementById('startVidRec').classList.remove('hidden');
};

removeVidBtn.onclick=()=>{vidPreview.classList.add('hidden'); removeVidBtn.classList.add('hidden');};

// --------------------- Audio ---------------------
const audPreview=document.getElementById('audPreview');
const removeAudBtn=document.getElementById('removeAudBtn');

document.getElementById('startAudRec').onclick=async()=>{
try {
const stream=await navigator.mediaDevices.getUserMedia({audio:true});
audRecorder=new MediaRecorder(stream); audChunks=[];
audRecorder.ondataavailable=e=>audChunks.push(e.data);
audRecorder.onstop=()=>{audPreview.src=URL.createObjectURL(new Blob(audChunks,{type:'audio/webm'})); audPreview.classList.remove('hidden'); removeAudBtn.classList.remove('hidden');};
audRecorder.start();
document.getElementById('stopAudRec').classList.remove('hidden'); document.getElementById('startAudRec').classList.add('hidden');
} catch (error) {
console.error("Error accessing audio recorder:", error);
alert("Could not access microphone. Please check permissions.");
}
};

document.getElementById('stopAudRec').onclick=()=>{
if(audRecorder){audRecorder.stop(); audRecorder=null;}
document.getElementById('stopAudRec').classList.add('hidden'); document.getElementById('startAudRec').classList.remove('hidden');
};

removeAudBtn.onclick=()=>{audPreview.classList.add('hidden'); removeAudBtn.classList.add('hidden');};

// --------------------- Submit report ---------------------
function submitReport(){
const current=localStorage.getItem('civic_current_user')||currentUserEmail;
if(!current){alert('Sign in first'); goto('userLogin'); return;}
const desc=document.getElementById('issueDesc').value.trim();
const cat=document.getElementById('issueCat').value;
const loc=document.getElementById('locationTxt').value.trim();
const lat=document.getElementById('locationTxt').dataset.lat||null;
const lng=document.getElementById('locationTxt').dataset.lng||null;
if(!desc||!cat||!loc){alert('Fill description, category, location'); return;}
const img=!imgPreview.classList.contains('hidden')?imgPreview.src:null;
const vid=!vidPreview.classList.contains('hidden')?vidPreview.src:null;
const aud=!audPreview.classList.contains('hidden')?audPreview.src:null;
const rep={id:Date.now(),user:current,desc,cat,location:loc,lat,lng,img,vid,aud,status:'Submitted'};
reports.push(rep); localStorage.setItem('civic_reports',JSON.stringify(reports));
document.getElementById('issueDesc').value=''; document.getElementById('issueCat').value=''; document.getElementById('locationTxt').value=''; delete document.getElementById('locationTxt').dataset.lat; delete document.getElementById('locationTxt').dataset.lng;
imgPreview.classList.add('hidden'); vidPreview.classList.add('hidden'); audPreview.classList.add('hidden');
removeImgBtn.classList.add('hidden'); removeVidBtn.classList.add('hidden'); removeAudBtn.classList.add('hidden');
const msg=document.getElementById('submitMsg'); msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),2000);
renderUserReports(); updateCharts();
}

// --------------------- Render reports ---------------------
function renderUserReports(){
const container=document.getElementById('userReports'); container.innerHTML='';
const current=localStorage.getItem('civic_current_user')||currentUserEmail;
const myReports=reports.filter(r=>r.user===current);
if(myReports.length===0){ container.innerHTML='<p class="small">No reports yet.</p>'; return; }
myReports.reverse().forEach(r=>{
const d=document.createElement('div'); d.className='report';
let inner=`<p><b>${escapeHtml(r.cat)}</b> â€” ${escapeHtml(r.desc)}</p>`;
if(r.img) inner+=`<div class="preview"><img src="${r.img}"></div>`;
if(r.vid) inner+=`<div class="preview"><video src="${r.vid}" controls></video></div>`;
if(r.aud) inner+=`<div class="preview"><audio src="${r.aud}" controls></audio></div>`;
if(r.location){ inner+=`<p class="small">ğŸ“ ${escapeHtml(r.location)}</p>`;
if(r.lat&&r.lng) inner+=`<iframe width="100%" height="200" style="border:0;margin-top:8px" src="https://www.google.com/maps?q=${r.lat},${r.lng}&z=15&output=embed"></iframe>`;}
inner+=`<p class="small">Status: <b>${r.status}</b></p>`;
d.innerHTML=inner; container.appendChild(d);
});
}

// --------------------- Admin reports ---------------------
function renderAllReports(){
const container=document.getElementById('allReports'); container.innerHTML='';
if(reports.length===0){ container.innerHTML='<p class="small">No reports yet.</p>'; return; }
[...reports].reverse().forEach(r=>{
const idx=reports.findIndex(x=>x.id===r.id); const d=document.createElement('div'); d.className='report';
let inner=`<p><b>${escapeHtml(r.cat)}</b> â€” ${escapeHtml(r.desc)}</p><p class="small">By: ${escapeHtml(r.user)}</p>`;
if(r.img) inner+=`<div class="preview"><img src="${r.img}"></div>`;
if(r.vid) inner+=`<div class="preview"><video src="${r.vid}" controls></video></div>`;
if(r.aud) inner+=`<div class="preview"><audio src="${r.aud}" controls></audio></div>`;
if(r.location){ inner+=`<p class="small">ğŸ“ ${escapeHtml(r.location)}</p>`;
if(r.lat&&r.lng) inner+=`<iframe width="100%" height="200" style="border:0;margin-top:8px" src="https://www.google.com/maps?q=${r.lat},${r.lng}&z=15&output=embed"></iframe>`;}
inner+=`<p class="small">Status: <b>${r.status}</b></p>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn" onclick="adminUpdate(${idx},'Accepted')">Accept</button>
<button class="btn" onclick="adminUpdate(${idx},'In Progress')">In Progress</button>
<button class="btn" onclick="adminUpdate(${idx},'Resolved')">Resolve</button>
<button class="btn btn-danger" onclick="adminDelete(${idx})">Delete</button>
</div>`;
d.innerHTML=inner; container.appendChild(d);
});
}

// --------------------- Admin Update/Delete ---------------------
function adminUpdate(idx,status){ reports[idx].status=status; localStorage.setItem('civic_reports',JSON.stringify(reports)); renderAllReports(); updateCharts(); }
function adminDelete(idx){ reports.splice(idx,1); localStorage.setItem('civic_reports',JSON.stringify(reports)); renderAllReports(); updateCharts(); }

// --------------------- Charts ---------------------
let chartObj=null;
function updateCharts(){
const ctx=document.getElementById('statusChart').getContext('2d');
const counts={'Submitted':0,'Accepted':0,'In Progress':0,'Resolved':0};
reports.forEach(r=>{ if(counts[r.status]!==undefined) counts[r.status]++; });
const data={labels:Object.keys(counts),datasets:[{label:'Reports Count',data:Object.values(counts),backgroundColor:['#ff4d4d','#ffcc00','#00e5ff','#00e676']}]};
if(chartObj) chartObj.destroy(); chartObj=new Chart(ctx,{type:'bar',data:data,options:{responsive:true,plugins:{legend:{display:false}}}});
}

// --------------------- Logout ---------------------
function logoutUser(){ localStorage.removeItem('civic_current_user'); currentUserEmail=null; goto('userLogin'); }

// --------------------- Escape HTML ---------------------
function escapeHtml(str){return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
</script>
</body>

</html>
